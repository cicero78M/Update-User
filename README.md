# CICERO_V2
*Last updated: 2026-02-07*

## Important: WhatsApp Client Migration

**The system has been migrated from WhatsApp Web.js to Baileys** (February 2026). This brings significant improvements:
- üöÄ 60% reduction in memory usage (no browser dependency)
- ‚ö° 80% faster startup times
- üîí More stable connections with multi-device API
- üì¶ Smaller deployment size (~500MB less per client)

**Action Required**: Existing WhatsApp sessions are incompatible. After deployment, users must re-scan QR codes. See [docs/baileys_migration_guide.md](docs/baileys_migration_guide.md) for complete migration details.

## Description

**Cicero_V2** is an automation backend for monitoring social media, managing editorial workflows, and orchestrating WhatsApp messaging. The service ingests Instagram and TikTok metrics for multiple clients, tracks attendance, powers daily/weekly reporting, manages premium subscriptions, and now drives the Penmas editorial approval process. Two WhatsApp sessions are maintained‚Äîone for operator interactions and another as a gateway for directorate broadcasts‚Äîwhile OTP distribution has moved to instant email delivery.

The full architecture is described in [docs/enterprise_architecture.md](docs/enterprise_architecture.md). Scheduled activities are listed in [docs/activity_schedule.md](docs/activity_schedule.md). See [docs/metadata_flow.md](docs/metadata_flow.md) for the data movement from collection to reporting. Additional guides are available for [server migration](docs/server_migration.md), [database migrations](docs/running_migrations.md), [RabbitMQ](docs/rabbitmq.md), [Redis](docs/redis.md), [database structure](docs/database_structure.md), [premium subscriptions](docs/premium_subscription.md), [Nginx configuration](docs/reverse_proxy_config.md), [PostgreSQL backups](docs/pg_backup_gdrive.md), [naming conventions](docs/naming_conventions.md), [Login API guide](docs/login_api.md), [Instagram Rapid API](docs/instaRapidApi.md), [WhatsApp user registration guide](docs/wa_user_registration.md), [WhatsApp client lifecycle & troubleshooting](docs/whatsapp_client_lifecycle.md), [workflow & usage guide](docs/workflow_usage_guide.md), and [editorial workflow](docs/wa_operator_request.md).
Accepted complaint layouts, including `Kendala` and `Rincian Kendala` headers, are documented in [docs/complaint_formats.md](docs/complaint_formats.md).
Role-aware deactivation flows (per-role removal across WhatsApp menus and REST) are covered in [docs/user_role_deactivation.md](docs/user_role_deactivation.md).

## Key Capabilities

- Multi-tenant Instagram and TikTok ingestion with RapidAPI fallbacks and deduplication middleware for idempotent requests.
- Automated WhatsApp digests, OTP notifications via SMTP email, and Google Contacts synchronisation for administrator address books.
- Editorial event planning, press-release drafting, and approval logging exposed under Penmas-protected routes.
- Directorat WhatsApp dirrequest menus that now include an Instagram all-data recap export (menu 4Ô∏è‚É£2Ô∏è‚É£) spanning September-to-current months with per-polres totals.
- Premium subscription management, link amplification (regular and khusus), and directorate-level recap exports generated by cron buckets tied to WhatsApp readiness.
- Aggregated analytics APIs for dashboards, including combined operator, directorate, and complaint views.
- Client info responses on the WhatsApp *clientrequest* menu now include the Polda name derived from each client's `regional_id` for clearer regional context.

## Requirements
- Node.js 20 or newer
- PostgreSQL and Redis (configure `.env` accordingly)
- Run `npm install` before starting

## Database Setup

For database initialization and migrations:
- See [docs/running_migrations.md](docs/running_migrations.md) for migration procedures
- Use `node scripts/run_migration.js <migration-file>` to safely run migrations
- The schema is defined in `sql/schema.sql`
- Individual migrations are in `sql/migrations/`

---

## Folder Structure

```
Cicero_V2/
‚îú‚îÄ‚îÄ app.js                       # Application entry point
‚îú‚îÄ‚îÄ package.json                 # NPM configuration
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/                  # Environment and Redis config
‚îÇ   ‚îú‚îÄ‚îÄ db/                      # Database adapters
‚îÇ   ‚îú‚îÄ‚îÄ controller/              # Express controllers
‚îÇ   ‚îú‚îÄ‚îÄ model/                   # Database models
‚îÇ   ‚îú‚îÄ‚îÄ cron/                    # Scheduled jobs
‚îÇ   ‚îú‚îÄ‚îÄ handler/                 # WhatsApp menu logic
‚îÇ   ‚îú‚îÄ‚îÄ service/                 # Business services
‚îÇ   ‚îú‚îÄ‚îÄ repository/              # Query helpers
‚îÇ   ‚îú‚îÄ‚îÄ utils/                   # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ routes/                  # Express routers
‚îÇ   ‚îú‚îÄ‚îÄ middleware/              # Global middleware
‚îÇ   ‚îî‚îÄ‚îÄ data/                    # Static datasets (e.g. satker mappings)
‚îú‚îÄ‚îÄ laphar/                      # Legacy recap artefacts kept for reference
‚îú‚îÄ‚îÄ pegiat_medsos_apps/          # Android client (embedded reference copy)
‚îî‚îÄ‚îÄ tests/                       # Jest tests
```

---

## API Overview

The API exposes endpoints for managing clients and users, fetching Instagram and TikTok data, handling OAuth callbacks, orchestrating editorial events, and providing dashboard statistics. Dedicated routers cover aggregator widgets, directorate recap exports, complaint handling, Penmas press releases, premium requests, link amplification (regular and khusus), and OTP-powered data-claim flows. Detailed documentation for each route is available in the source code comments (`src/routes/**/*.js`).

Basic health checks are available without authentication. `GET` or `POST /` returns `{ "status": "ok" }` for load balancers or uptime probes, and `/_next/dev/` responds the same to keep Next.js dev proxies from spamming logs.

Security note: requests that attempt to access `.env`-style paths are short-circuited with a 404 response to reduce log noise and prevent accidental exposure of sensitive configuration files.

When a request requires data for a particular client, include the client's identifier as a query parameter:

```
GET /api/analytics?client_id=demo_client
```

This allows operators to scope responses to the correct client.

### Dashboard Complaint Response Endpoints

Dashboard operators can request formatted complaint responses (including WhatsApp delivery status) via:
- `POST /api/dashboard/komplain/insta`
- `POST /api/dashboard/komplain/tiktok`

Payload and response details are documented in [docs/complaint_response.md](docs/complaint_response.md).

**Frontend Integration Guide**: For frontend developers experiencing 403 errors or needing to integrate the complaint endpoints, see the comprehensive guide in [docs/frontend_complaint_api_guide.md](docs/frontend_complaint_api_guide.md) which covers authentication requirements, payload structure, error handling, and complete implementation examples. For general frontend connectivity issues (CORS, authentication, deduplication), refer to [docs/frontend_endpoint_access_troubleshooting.md](docs/frontend_endpoint_access_troubleshooting.md).

### Dashboard Anev Endpoint (`/api/dashboard/anev`)

This endpoint surfaces premium analytics and engagement compliance for dashboard users. Access is guarded by:
- `Authorization: Bearer <dashboard-jwt>` issued by the dashboard login flow (`verifyDashboardToken` middleware).
- Premium subscription via `dashboardPremiumGuard` with allowed tiers from `DASHBOARD_PREMIUM_ALLOWED_TIERS` (default: `tier1,tier2,premium_1`). Expired or missing premium status returns HTTP 403 with the current tier/expiry snapshot.
- `client_id` authorization: the requested `client_id` (via query or `X-Client-Id` header) must exist in `dashboard_user.client_ids`. Operators with multiple clients must supply `client_id` explicitly; otherwise a 400 error is returned.
- `role` is required; `scope` only accepts `org` or `direktorat` (400 on invalid scope). `regional_id` is optional but normalised to uppercase.
- User lookups for Anev and polres dashboards now reuse the User Directory helper (active users only) with the same `scope` (`org`/`direktorat`) rules and optional `regional_id` filtering, ensuring both experiences draw from the same operator dataset.

Query parameters:
- `time_range`: `today`, `7d` (default), `30d`, `90d`, `custom`, `all`. `custom` requires `start_date` and `end_date` in Asia/Jakarta timezone.
- `client_id`, `role`, `scope`, `regional_id`, `start_date`, `end_date`. `client_id` may also be sent as `X-Client-Id` header.

Response structure highlights:
- `user_directory` echoes active dashboard users from the shared User Directory helper, including `user_id`, `nama`, `divisi`, `client_id`, and social handles (`kontak_sosial.instagram`/`kontak_sosial.tiktok`).
- `instagram_engagement` and `tiktok_engagement` expose `total_posts`, aggregate likes/comments, and `per_user` breakdowns where each username has been mapped back to `user_id` (unmapped usernames are still listed with `unmapped=true`).
- Legacy `aggregates.*` remain for backward compatibility and reuse the same counts/derivations as the new DTO sections.

Example request:
```bash
curl -X GET "https://api.example.com/api/dashboard/anev?time_range=30d&role=ditbinmas&scope=org" \
  -H "Authorization: Bearer <dashboard-jwt>" \
  -H "X-Client-Id: DITBINMAS"
```

Example response (truncated):
```json
{
  "success": true,
  "data": {
    "user_directory": [
      {
        "user_id": "u-1",
        "nama": "USER SATKER",
        "divisi": "SUBBID PENMAS",
        "client_id": "DITBINMAS",
        "kontak_sosial": {
          "instagram": "user_ig",
          "tiktok": "user_tt"
        }
      }
    ],
    "instagram_engagement": {
      "total_posts": 12,
      "total_likes": 320,
      "per_user": [
        {
          "user_id": "u-1",
          "nama": "USER SATKER",
          "divisi": "SUBBID PENMAS",
          "client_id": "DITBINMAS",
          "username": "user_ig",
          "kontak_sosial": {
            "instagram": "user_ig",
            "tiktok": "user_tt"
          },
          "likes": 10
        }
      ]
    },
    "tiktok_engagement": {
      "total_posts": 8,
      "total_comments": 110,
      "per_user": [
        {
          "user_id": "u-1",
          "nama": "USER SATKER",
          "divisi": "SUBBID PENMAS",
          "client_id": "DITBINMAS",
          "username": "user_tt",
          "kontak_sosial": {
            "instagram": "user_ig",
            "tiktok": "user_tt"
          },
          "comments": 4
        }
      ]
    },
    "filters": {
      "client_id": "DITBINMAS",
      "role": "ditbinmas",
      "scope": "org",
      "regional_id": "JATIM",
      "time_range": "30d",
      "start_date": "2025-01-09T00:00:00+07:00",
      "end_date": "2025-02-07T23:59:59.999+07:00",
      "permitted_time_ranges": ["today", "7d", "30d", "90d", "custom", "all"]
    },
    "aggregates": {
      "total_users": 45,
      "instagram_posts": 12,
      "tiktok_posts": 8,
      "total_likes": 320,
      "total_comments": 110,
      "expected_actions": 20,
      "compliance_per_pelaksana": [
        {
          "user_id": "u-1",
          "nama": "USER SATKER",
          "likes": 10,
          "comments": 4,
          "total_actions": 14,
          "completion_rate": 0.7
        }
      ]
    }
  }
}
```

Development reminder: after updating this endpoint or its documentation, run `npm run lint` and `npm test` to align with repository guidelines.

## Logging Timezone

Application logs are timestamped using the Asia/Jakarta timezone by the console wrapper in `src/utils/logger.js`. Expect log prefixes in the format `YYYY-MM-DDTHH:mm:ss.SSS+07:00` for consistent Jakarta-local monitoring.

## Deployment & Environment

1. **Clone and install dependencies**
    ```bash
    git clone <repo-url>
    cd Cicero_V2
    npm install
    ```
2. **Copy `.env.example` to `.env`** and update the values:
    ```ini
    PORT=3000
    DB_USER=cicero
    DB_HOST=localhost
    DB_NAME=cicero_db
    DB_PASS=secret
    DB_PORT=5432
    DB_DRIVER=postgres
    REDIS_URL=redis://localhost:6379
    ADMIN_WHATSAPP=628xxxxxx,628yyyyyy
    GATEWAY_WHATSAPP_ADMIN=628zzzzzz
    APP_SESSION_NAME=wa-admin
    USER_WA_CLIENT_ID=wa-userrequest-prod
    GATEWAY_WA_CLIENT_ID=wa-gateway-prod
    WA_AUTH_DATA_PATH=/var/lib/cicero/wa-sessions
    WA_AUTH_CLEAR_SESSION_ON_REINIT=false
    WA_WEB_VERSION_CACHE_URL=https://raw.githubusercontent.com/wppconnect-team/wa-version/main/versions.json
    WA_WEB_VERSION=
    WA_WEB_VERSION_RECOMMENDED=
    WA_WWEBJS_BROWSER_LOCK_BACKOFF_MS=20000
    WA_WWEBJS_PROTOCOL_TIMEOUT_MS=120000
    WA_WWEBJS_PROTOCOL_TIMEOUT_MS_USER=120000
    WA_WWEBJS_PROTOCOL_TIMEOUT_MS_GATEWAY=180000
    WA_WWEBJS_PROTOCOL_TIMEOUT_MAX_MS=300000
    WA_WWEBJS_PROTOCOL_TIMEOUT_BACKOFF_MULTIPLIER=1.5
    ENABLE_DIRREQUEST_GROUP=true
    CORS_ORIGIN=http://localhost:3000
    ALLOW_DUPLICATE_REQUESTS=false
    SECRET_KEY=your-secret
    JWT_SECRET=your-jwt-secret
    RAPIDAPI_KEY=xxxx
    RAPIDAPI_FALLBACK_KEY=xxxx-secondary
    RAPIDAPI_FALLBACK_HOST=tiktok-api6.p.rapidapi.com
    AMQP_URL=amqp://localhost
    DEBUG_FETCH_INSTAGRAM=false
    GOOGLE_CONTACT_SCOPE=https://www.googleapis.com/auth/contacts
    GOOGLE_SERVICE_ACCOUNT=/path/to/service-account.json
    GOOGLE_IMPERSONATE_EMAIL=admin@example.com
    BACKUP_DIR=./backups
    GOOGLE_DRIVE_FOLDER_ID=your-drive-folder-id
    SMTP_HOST=smtp.example.com
    SMTP_PORT=587
    SMTP_USER=otp@example.com
    SMTP_PASS=super-secret
    SMTP_FROM="Cicero OTP" <otp@example.com>
    CONTACT_CACHE_TTL_MS=300000
    DASHBOARD_RESET_TOKEN_EXPIRY_MINUTES=15
    DASHBOARD_PASSWORD_RESET_URL=https://dashboard.example.com/reset
    DASHBOARD_URL=https://dashboard.example.com
    ADMIN_NOTIFY_LOGIN=true
    DIRREQUEST_ENGAGE_RANK_RECIPIENT=628xxxx@c.us
    LAPHAR_ARCHIVE=false
    ```
   Use `DB_DRIVER=postgres`, `postgresql`, or `pg` when connecting to Postgres so the backend applies the session settings (`app.current_*`) required by database row-level security. Switching `DB_DRIVER` to another value disables these Postgres-only settings.
   `ADMIN_WHATSAPP` accepts numbers with or without the `@c.us` suffix. When the suffix is omitted, the application automatically appends it.
   `USER_WA_CLIENT_ID` defines the session identifier used by the user-facing WhatsApp client. Change it to isolate session data if needed.
   `USER_WA_CLIENT_ID` dan `GATEWAY_WA_CLIENT_ID` wajib unik (berbeda dari default maupun satu sama lain). Contoh benar: `USER_WA_CLIENT_ID=wa-userrequest-prod` dan `GATEWAY_WA_CLIENT_ID=wa-gateway-prod`.
   `USER_WA_CLIENT_ID` **harus lowercase dan tidak boleh default `wa-userrequest`**. Service akan menghentikan proses sejak awal jika nilai masih default, mengandung huruf besar, atau folder `session-<clientId>` di `WA_AUTH_DATA_PATH` memakai casing berbeda.
   `GATEWAY_WA_CLIENT_ID` **harus lowercase dan tidak boleh default `wa-gateway`**. Service akan menghentikan proses sejak awal jika nilai masih default, mengandung huruf besar, atau folder `session-<clientId>` di `WA_AUTH_DATA_PATH` memakai casing berbeda.
   Saat mengganti `GATEWAY_WA_CLIENT_ID`, bersihkan session lama di `WA_AUTH_DATA_PATH` dengan cara rename atau hapus folder `session-<clientId>` yang lama agar tidak meninggalkan sesi usang.
   `GATEWAY_WHATSAPP_ADMIN` identifies the WhatsApp account that receives gateway connection updates.
   `APP_SESSION_NAME` is the session folder name used for the main WhatsApp client; override it when running multiple instances on the same host.
   `WA_AUTH_DATA_PATH` is the session storage path for WhatsApp authentication (default: `~/.cicero/baileys_auth`). The system uses Baileys multi-file auth state, storing credentials and keys in separate files. Startup performs validation on `<WA_AUTH_DATA_PATH>/session-<clientId>`; when invalid or not writable, initialization stops with appropriate error messages plus remediation hints (fix permissions/ownership or set a valid path).
   `WA_AUTH_CLEAR_SESSION_ON_REINIT=true` forces the adapter to remove the `session-<clientId>` folder before reinitializing after `auth_failure`/logout-related disconnects. Because lifecycle recovery is centralized in adapter, `waService` no longer performs fallback readiness polling (`getState`) or layered reconnect retries.
   `WA_READY_TIMEOUT_MS` (default `60000`) controls how long service waits for `ready` before treating a client as not-ready in wait helpers.
   `WA_GATEWAY_READY_TIMEOUT_MS` overrides `WA_READY_TIMEOUT_MS` only for `WA-GATEWAY`.
   ```json
   {
     "version": "2.3000.1019311536",
     "platform": "web",
     "releaseDate": "2024-04-01"
   }
   ```
   Perbarui pin (`WA_WEB_VERSION` atau `WA_WEB_VERSION_RECOMMENDED`) saat WhatsApp Web merilis update besar dan log `initialize`/`load` menunjukkan error setelah update (misalnya blank page atau error `LocalWebCache.persist`/`Cannot read properties of null`). Biasanya cukup sinkronkan ke versi terbaru dari payload cache yang sudah tervalidasi.
   `WA_WWEBJS_PROTOCOL_TIMEOUT_MS` sets the Puppeteer protocol timeout used by whatsapp-web.js for `Runtime.callFunctionOn` and other DevTools protocol calls. Keep the default `120000` ms for typical deployments, and increase it (for example `180000`) when you expect slow or high-latency connections to WhatsApp Web.
   Per-client override is available in two formats: a stable role alias (based on the client ID prefix) and a clientId-specific suffix. Role alias mapping uses `WA_WWEBJS_PROTOCOL_TIMEOUT_MS_GATEWAY` for client IDs that start with `wa-gateway` and `WA_WWEBJS_PROTOCOL_TIMEOUT_MS_USER` for IDs that start with `wa-user`. For example, for `wa-gateway-prod` you can set `WA_WWEBJS_PROTOCOL_TIMEOUT_MS_GATEWAY=180000`, or use the explicit client suffix `WA_WWEBJS_PROTOCOL_TIMEOUT_MS_WA_GATEWAY_PROD=180000` (client ID uppercased with non-alphanumerics replaced by underscores). Recommended production setup: keep `WA_WWEBJS_PROTOCOL_TIMEOUT_MS=120000` for WA admin, and raise the per-client override for user/gateway clients that see frequent `Runtime.callFunctionOn timed out` errors.
   The adapter can auto-increase the protocol timeout after runtime timeouts during initialization. Control the cap with `WA_WWEBJS_PROTOCOL_TIMEOUT_MAX_MS` (default 300000) and the growth rate with `WA_WWEBJS_PROTOCOL_TIMEOUT_BACKOFF_MULTIPLIER` (default 1.5). Set the max to a value higher than your per-client timeout if you want auto-bumps to take effect.
   `ENABLE_DIRREQUEST_GROUP=false` disables all Ditbinmas dirRequest cron jobs at once while leaving other schedules intact.
   `GOOGLE_SERVICE_ACCOUNT` may be set to a JSON string or a path to a JSON file. If the value starts with `/` or ends with `.json`, the application reads the file; otherwise it parses the variable directly as JSON. `GOOGLE_IMPERSONATE_EMAIL` should be set to the Workspace user to impersonate when performing contact operations.
   `SMTP_*` variables enable OTP and complaint notifications through email (`claimRoutes.js`). Leave them unset to disable email delivery in development.
   `CONTACT_CACHE_TTL_MS` controls how long Google contact lookups stay cached in memory.
   `DASHBOARD_RESET_TOKEN_EXPIRY_MINUTES` and `DASHBOARD_PASSWORD_RESET_URL` customise dashboard password reset links.
   `RAPIDAPI_KEY` wajib diisi untuk semua fetch Instagram/TikTok. Endpoint seperti `/api/insta/rapid-info` akan mengembalikan error operasional (500/503) bila `RAPIDAPI_KEY` belum di-set, sebelum melakukan request keluar.
   `RAPIDAPI_FALLBACK_KEY` and `RAPIDAPI_FALLBACK_HOST` allow the TikTok fetcher to call an alternate RapidAPI host (`/user/videos`) when the primary `tiktok-api23` host fails or returns an empty payload. If the primary host only returns posts outside of the current Jakarta day (no tasks for today), the fetcher retries via the fallback host using the username to avoid missing same-day content‚Äîbut only during the 11:00‚Äì17:15 WIB window to align with operational hours. The fallback endpoint should return a `videos` or `result.videos` array containing TikTok objects with identifiers (`video_id`/`id`) and timestamps (`create_time`/`createTime`) so the backend can normalize them.
   Untuk Instagram, `RAPIDAPI_FALLBACK_KEY`/`RAPIDAPI_FALLBACK_HOST` digunakan sebagai host cadangan saat host utama mengembalikan 401/403 (mis. key utama invalid atau rate limit). Isi `RAPIDAPI_FALLBACK_HOST` dengan host RapidAPI Instagram yang kompatibel agar fungsi `instaRapidService` otomatis retry menggunakan key/host cadangan.

3. **Set up Redis**
    ```bash
    sudo apt-get install redis-server
    sudo systemctl enable redis-server
    sudo systemctl start redis-server
    ```
4. **Set up RabbitMQ**
   ```bash
   sudo apt-get install rabbitmq-server
   sudo systemctl enable rabbitmq-server
   sudo systemctl start rabbitmq-server
   ```
5. **Initialize the database** using scripts in `sql/schema.sql`.
6. **Start the application**
    ```bash
    npm start
    ```
    Or with PM2 (uses `ecosystem.config.js`):
    ```bash
    pm2 start ecosystem.config.js --env production
    ```
    The PM2 config watches only the code paths (`app.js`, `src/`) in non-production mode and ignores data folders/files to prevent restart loops when uploads or exports change. Ignored paths include `laphar/`, `logs/`, `uploads/`, `backups/`, and file patterns such as `*.txt`, `*.csv`, `*.tsv`, `*.log`, `*.json`, `*.xlsx`, `*.xls`, `*.zip`. In production, `watch` is disabled (`watch: false`) so restarts occur only on deploy/manual restart.
7. **Lint & Test**
    ```bash
    npm run lint
    npm test
    ```

---

## Google Contacts Integration

The application can synchronize Google Workspace contacts using the People API. Contacts are cached in-memory based on `CONTACT_CACHE_TTL_MS` to reduce API churn, and stored phone numbers are reused by WhatsApp helpers. Configure the integration as follows:

1. **Enable the People API** in your Google Cloud project.
2. **Create a service account** and enable **Domain-wide delegation**.
3. **Grant domain-wide delegation** in the Google Admin console:
   - Note the service account's client ID.
   - Under **Security ‚Üí API controls ‚Üí Domain-wide delegation**, add a new client with that client ID and the scope defined in `GOOGLE_CONTACT_SCOPE`.
4. **Set environment variables**:
   - `GOOGLE_SERVICE_ACCOUNT` ‚Äì JSON key or file path for the service account.
   - `GOOGLE_CONTACT_SCOPE` ‚Äì OAuth scope for contacts, e.g. `https://www.googleapis.com/auth/contacts`.
   - `GOOGLE_IMPERSONATE_EMAIL` ‚Äì Workspace user email to impersonate when accessing contacts.
   - `CONTACT_AUTH_COOLDOWN_MS` ‚Äì cooldown before re-attempting Google auth after missing/invalid credentials (defaults to 300000 ms).
   - `BACKUP_DIR` ‚Äì temporary folder for local database dumps.
   - `GOOGLE_DRIVE_FOLDER_ID` ‚Äì Google Drive folder ID to receive backups.

For detailed setup and usage examples, see [`docs/google_contacts_integration.md`](docs/google_contacts_integration.md).

---

## Database Backup & Backups to Drive

Example commands for backing up and restoring the database:

```bash
pg_dump -U <dbuser> -h <host> -d <dbname> > cicero_backup.sql
psql -U <dbuser> -h <host> -d <dbname> < cicero_backup.sql
```

A cron job (`src/cron/cronDbBackup.js`) runs daily at **04:00** (Asia/Jakarta), storing dumps in `BACKUP_DIR` and uploading them to the Drive folder defined by `GOOGLE_DRIVE_FOLDER_ID`. Backups reuse the same Google credentials used for contact sync.

---

## WhatsApp Sessions & Cron Buckets

WhatsApp sessions are launched from `app.js`: `waClient` for operator interactions, `waUserClient` for user-request flows, and `waGatewayClient` for broadcast/reporting flows. Cron buckets remain paused until each session signals readiness, preventing duplicate schedules after restarts. Manifest entries in `src/cron/cronManifest.js` drive the always/`waClient` buckets, while all Ditbinmas dirRequest jobs are bundled in `src/cron/dirRequest/index.js` and registered via `registerDirRequestCrons(waGatewayClient)` so they share the same gateway context and can be toggled with `ENABLE_DIRREQUEST_GROUP`.

- The three WhatsApp sessions initialize in parallel, so QR/ready delays or failures in one session will not block the other sessions from connecting. Each client keeps its own `[WA]`, `[WA-USER]`, or `[WA-GATEWAY]` startup/error logs for easier traceability.
- WhatsApp readiness is tracked per client. Message handlers await the specific client's `waitForWaReady()` before processing, and the service logs `READY` for WA/WA-USER/WA-GATEWAY when lifecycle events confirm a connected session.
- Outbound message sending is serialized per client (`PQueue` concurrency 1), waits for readiness, and executes a single send attempt only (no automatic retry/backoff/jitter). Failures are re-thrown with `sendFailureMetadata` (`jid`, `clientLabel`, `messageType`) and logged as structured `wa_send_message_failed` events with per-client failure counters for NOC follow-up.
- Fallback readiness checks run after initialization for **all** WhatsApp clients. After ~60 seconds the service calls `getState()` and logs messages such as `[WA-USER] getState: CONNECTED` or `[WA-GATEWAY] getState error: ...`. If `isReady()`/`getState()` reports `CONNECTED/open`, the fallback is marked complete (one-shot per start/restart) and will not reschedule until the next reset triggered by `qr`, `authenticated`, `auth_failure`, disconnect/change_state, or a new `connect()`/`reinitialize()` call.
- Reconnects are guarded by a shared connect lock: if a client is already initializing, further `connect()` calls (including hard-init retries or disconnect-driven reconnects) will wait for or skip the in-flight promise instead of launching a parallel session. This keeps the default retry timing the same (e.g., 5s reconnect delay, exponential hard-init retry delays) while preventing overlapping initializations.

- `src/cron/cronDirRequestFetchSosmed.js` now runs as a standalone cron in the `always` manifest bucket and fires every 30 minutes from **06:00‚Äì22:00** (Asia/Jakarta), so it does not wait for any WhatsApp gateway/user readiness before refreshing Ditbinmas Instagram/TikTok data and broadcasting deltas when available.

- The Instagram laphar cron (`cronInstaLaphar.js`) has been retired and removed from the manifest and seed data. New deployments will no longer register or seed this job; existing environments can safely drop its `cron_job_config` row if present.

- The dirRequest cron group now focuses on reminder, Satbinmas media, and BIDHUMAS evening schedules; custom sequence and combined recap jobs are no longer registered in this bucket.

- `src/cron/cronDirRequestBidhumasEvening.js` adds a **22:00** (Asia/Jakarta) BIDHUMAS-only cron that first runs `runDirRequestFetchSosmed({ forceEngagementOnly: true })` (refresh likes/comments only, skipping new post fetches) and then executes dirRequest menus **6** and **9** specifically for the BIDHUMAS WhatsApp group and its super admin recipients. The job shares the dirRequest bucket and inherits the same WhatsApp readiness guardrails as the other dirRequest schedules.

The OTP worker (`src/service/otpQueue.js`) now resolves immediately because OTP emails are sent synchronously via SMTP to minimise delays.

---

## Troubleshooting

- **DB connection errors** ‚Äì check database credentials and PostgreSQL status.
- **WhatsApp not connected** ‚Äì rescan the QR code, confirm session folders (`APP_SESSION_NAME`, `USER_WA_CLIENT_ID`, `GATEWAY_WA_CLIENT_ID`), and check logs for connection errors. If authentication fails repeatedly, delete the session folder and re-authenticate by scanning a new QR code. The system now uses Baileys which doesn't require a browser, making connection more stable and faster.
- **Connection issues** ‚Äì Baileys uses WebSocket connections to WhatsApp servers. Check network connectivity and ensure no firewalls are blocking WebSocket traffic. If connections are unstable, verify the session credentials are valid and not corrupted. For authentication issues, delete the session folder and re-scan the QR code.
- **Email OTP delivery failed** ‚Äì verify `SMTP_*` variables and network egress.
- **External API errors** ‚Äì verify `RAPIDAPI_KEY` and check application logs.
- **Cron jobs not running** ‚Äì confirm cron buckets activated after WhatsApp readiness and verify timezone settings (`Asia/Jakarta`).

---

## Security Notes

- Do not upload `.env` to a public repository.
- All POST/PUT endpoints perform strict validation.
- Only admins from the environment variables can trigger manual WhatsApp commands.
- Back up the database regularly and test recovery procedures.

## Request Deduplication

The middleware in [`src/middleware/dedupRequestMiddleware.js`](src/middleware/dedupRequestMiddleware.js) hashes non-GET requests and caches them in Redis for five minutes. Identical requests sent again within that window receive an HTTP 429 response. Claim endpoints under `/api/claim` are exempt so that the OTP flow can be retried without delay. Set `ALLOW_DUPLICATE_REQUESTS=true` to bypass this protection during development.

---

## Scaling & Monitoring

- Use PM2 clusters and separate processes if load is high.
- Monitor database health, cron jobs, and WhatsApp logs.
- Add indexes to frequently queried fields.
- Cache Instagram and TikTok profiles in Redis (`profileCacheService.js`) to improve response times.

### TikTok fetch timezone handling

- TikTok timestamps from RapidAPI are treated as **UTC** and normalized during upsert so the database stores them consistently.
- Date-based filters for `tiktok_post.created_at` convert the stored value from UTC to **Asia/Jakarta** before casting to `date` (e.g., `(created_at AT TIME ZONE 'UTC') AT TIME ZONE 'Asia/Jakarta'`) to avoid off-by-one errors around midnight.
- When adding new fetchers or reports that rely on TikTok posting dates, reuse this double `AT TIME ZONE` pattern to keep late-night UTC posts counted on the correct Jakarta calendar day.

## High Volume Queue (RabbitMQ)

- Use RabbitMQ to process large jobs asynchronously.
- Configure the connection URL in `AMQP_URL`.
- Implement helper functions (e.g. `publishToQueue` and `consumeQueue`) as needed for your project.

---

## License

See the LICENSE file in this repository.

## Contributors & Support

Contact the repository admin for access, issues, or additional contributors.

---

> This documentation is automatically generated based on code analysis and development history.
